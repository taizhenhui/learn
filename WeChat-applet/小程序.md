# 微信小程序-云开发



### 简介

- 小程序·云开发是微信团队联合腾讯云推出的专业的小程序开发服务。

- 开发者可以使用云开发快速开发小程序、小游戏、公众号网页等，并且原生打通微信开放能力。

- 开发者无需搭建服务器，可免鉴权直接使用平台提供的`API`进行业务开发
  小程序

- 云开发又简称`tcb`，是微信官方给我们提供的基于腾讯云的云服务器。目前云开发包含：`云数据库，云函数，云存储，云调用`。

  

### 优势



1. 无需搭建服务器，快速构建小程序、公众号

   > 无需搭建服务器，只需使用平台提供的各项能力，即可快速开发业务。

2. 免登录、免鉴权调用微信开放服务

   > 无需管理证书、签名、秘钥，直接调用微信 `API` 。复用微信私有协议及链路，保证业务安全性。

3. 统一开发多端应用

   > 支持环境共享，一个后端环境可开发多个小程序、公众号、网页等，便捷复用业务代码与数据。

4. 按量计费，成本更低

   > 支持按量计费模式，后端资源根据业务流量自动扩容，先使用后付费，无需支付闲置成本。



### 能力



1. 储存数据与文件

   > [云数据库：](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/database.html) 文档型数据库，稳定可靠；支持在小程序端和云函数中调用。

   > [存储：](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/storage.html) 云端文件存储，自带 `CDN`加速，支持在前端直接上传/下载，可在云开发控制台可视化管理。

2. 运行后端代码

   > [云函数：](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions.html) 在云端运行的代码，微信私有协议天然鉴权，开发者只需编写自身业务逻辑代码。

3. 扩展能力

   > [静态网站：](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/staticstorage/introduction.html) 快速部署网站，支持自定义域名、网站防刷等配置。

   > [内容管理（CMS）：](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/extensions/cms/introduction.html) 一键部署，可视化管理文本、Markdown、图片等多种内容，使用云数据库读取数据并使用数据。

4. 打通微信生态

   > [云调用：](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/openapi/openapi.html) 云函数内免鉴权调用小程序开放接口，包括服务端调用、获取开放数据等能力。

   > [微信支付：](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/wechatpay/wechatpay.html) 免鉴权、免签名计算、免 access_token，在云函数内原生调用微信支付接口。

   > [环境共享：](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/resource-sharing/introduce.html) 跨账号资源和能力复用，可授权云开发资源给其他小程序/公众号使用。





## 基础能力

### 初始化

在小程序端开始使用云能力前，需先调用 `wx.cloud.init` 方法完成云能力初始化。



#### 小程序端初始化

`wx.cloud.init` 方法的定义如下：

```js
function init(options): void

// app.js
App({
  // 小程序启动，就会执行
  onLaunch(){
    wx.cloud.init({
      env: 'tai-5244-7gj4diwh4fc673d0' // 环境id
    })
  }
})

```

`wx.cloud.init` 方法接受一个可选的 `options 参数`，方法没有返回值。方法只能调用一次，多次调用时只有第一次调用生效。



`options` 参数定义了云开发的默认配置，该配置会作为之后调用其他所有云 API 的默认配置，`options` 提供的可选配置如下：

| 字段      | 数据类型         | 必填 | 默认值 | 说明                                                         |
| :-------- | :--------------- | :--- | :----- | :----------------------------------------------------------- |
| env       | string \| object | 是   |        | 后续 API 调用的默认环境配置，传入字符串形式的环境 ID 可以指定所有服务的默认环境，传入对象可以分别指定各个服务的默认环境，见下方详细定义 |
| traceUser | boolean          | 否   | false  | 是否在将用户访问记录到用户管理中，在控制台中可见             |



当 `env` 传入参数为对象时，可以指定各个服务的默认环境，可选字段如下：

| 字段      | 数据类型 | 必填 | 默认值 | 说明                    |
| :-------- | :------- | :--- | :----- | :---------------------- |
| database  | string   | 否   | 空     | 数据库 API 默认环境配置 |
| storage   | string   | 否   | 空     | 存储 API 默认环境配置   |
| functions | string   | 否   | 空     | 云函数 API 默认环境配置 |

**注意**：`env` 设置只会决定小程序端 API 调用的云环境，并不会决定云函数中的 API 调用的环境，在云函数中需要通过 `wx-server-sdk` 的 `init` 方法重新设置环境。





#### 云函数端初始化

`cloud.init` 方法的定义如下：

```ts
function init(options): void
```

`cloud.init` 方法接受一个可选的 `options 参数`，方法没有返回值。方法只能调用一次，多次调用时只有第一次调用生效。

`options` 参数定义了云开发的默认配置，该配置会作为之后调用其他所有云 API 的默认配置，`options` 提供的可选配置如下：



| 字段 | 数据类型         | 必填 | 默认值 | 说明                                                         |
| :--- | :--------------- | :--- | :----- | :----------------------------------------------------------- |
| env  | string \| object | 是   |        | 后续 API 调用的默认环境配置，传入字符串形式的环境 ID 或传入 [`cloud.DYNAMIC_CURRENT_ENV`](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-sdk-api/constant/constant.html) 可以指定所有服务的默认环境，传入对象可以分别指定各个服务的默认环境，见下方详细定义 |



当 `env` 传入参数为对象时，可以指定各个服务的默认环境，可选字段如下：

| 字段      | 数据类型 | 必填 | 默认值  | 说明                    |
| :-------- | :------- | :--- | :------ | :---------------------- |
| database  | string   | 否   | default | 数据库 API 默认环境配置 |
| storage   | string   | 否   | default | 存储 API 默认环境配置   |
| functions | string   | 否   | default | 云函数 API 默认环境配置 |
| default   | string   | 否   | 空      | 缺省时 API 默认环境配置 |

**注意**：`env` 设置只会决定本次云函数 API 调用的云环境，并不会决定接下来其他被调云函数中的 API 调用的环境，在其他被调云函数中需要通过 `init` 方法重新设置环境。



```js
const cloud = require('wx-server-sdk')
cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
})

exports.main = async (event) => {
  const { ENV, OPENID, APPID } = cloud.getWXContext()

  // 如果云函数所在环境为 abc，则下面的调用就会请求到 abc 环境的数据库
  const dbResult = await cloud.database().collection('test').get()

  return {
    dbResult,
    ENV,
    OPENID,
    APPID,
  }
}
```

> 注：上述代码中的 `env` 参数的值不能用 `cloud.getWXContext().ENV` 替代，因为在 `exports.main` 外部调用的 `getWXContext()` 无法获取到当前环境





### 云数据库



#### 创建第一个集合

打开控制台，选择 "数据库" 标签页，通过 "添加集合" 入口创建一个集合。假设我们要创建一个待办事项小程序，我们创建一个名为 `todos` 的集合。创建成功后，可以看到 `todos` 集合管理界面，界面中我们可以添加记录、查找记录、管理索引和管理权限。

![](https://res.wx.qq.com/wxdoc/dist/assets/img/console_database_ui.01f843f3.png)



#### 创建第一条记录

控制台提供了可视化添加数据的交互界面，点击 "添加记录" 添加我们的第一条待办事项

```json
{
  // 描述，String 类型
  "description": "learn mini-program cloud service",
  // 截止时间，Date 类型
  "due": Date("2018-09-01"),
  // 标签，Array 类型
  "tags": [
    "tech",
    "mini-program",
    "cloud"
  ],
  // 个性化样式，Object 类型
  "style": {
    "color": "red"
  },
  // 是否已完成，Boolean 类型
  "done": false
}
```





### 数据类型

云开发数据库提供以下几种数据类型：

- String：字符串
- Number：数字
- Object：对象
- Array：数组
- Bool：布尔值
- Date：时间
- Geo：多种地理位置类型
- Null



### 增删改查（SDK）



#### 初始化



在开始使用数据库 API 进行增删改查操作之前，需要先获取数据库的引用。以下调用获取默认环境的数据库的引用：

```js
const db = wx.cloud.database()
```



如需获取其他环境的数据库引用，可以在调用时传入一个对象参数，在其中通过 `env` 字段指定要使用的环境。此时方法会返回一个对测试环境数据库的引用。

示例：假设有一个环境名为 `test`，用做测试环境，那么可以如下获取测试环境数据库：

```js
const testDB = wx.cloud.database({
  env: 'test'
})
```



要操作一个集合，需先获取它的引用。在获取了数据库的引用后，就可以通过数据库引用上的 `collection` 方法获取一个集合的引用了，比如获取待办事项清单集合：

```js
const todos = db.collection('todos')
```





#### 查询数据

在记录和集合上都有提供 `get` 方法用于获取单个记录或集合中多个记录的数据

```js
let db = wx.cloud.database()
// 传统写法
db.collection('goods').get({ // 查询操作
	success(res) { // 成功
		console.log(res.data, 'res');
	},
	fail(err) { // 失败
  	console.log(err, 'err');
  }
})
```

```js
let db = wx.cloud.database()
// es6-promise写法
db.collection('goods').get().then( res => {
	console.log(res.data,'res');
}).catch(err=>{
	console.log(err);
})
```



##### 获取多个记录的数据

条件查询 where()

```js
db.collection('goods')
    .where({ // 查询条件
      name:'苹果',
    })
    .get().then( res => {
      console.log(res.data,'res');
      this.setData({
        list: res.data 
      })
    })
```



##### 获取一个记录的数据

单条数据查询 doc()

```js
    db.collection('goods')
    .doc("9890f4c66361d59e006dbc01034417bf")
    .get().then( res => {
      console.log(res.data,'res');
      this.setData({
        good: res.data 
      })
    }).catch(err=>{
      console.log(err);
    })
```





#### 插入(添加)数据

可以通过在集合对象上调用 `add` 方法往集合中插入一条记录。



























